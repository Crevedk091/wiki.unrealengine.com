(window.webpackJsonp=window.webpackJsonp||[]).push([[600],{748:function(e,t,i){"use strict";i.r(t);var a=i(28),r=Object(a.a)({},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[i("p",[e._v("Integrating Lua - Epic Wiki")]),e._v(" "),i("h1",{attrs:{id:"integrating-lua"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#integrating-lua"}},[e._v("#")]),e._v(" Integrating Lua")]),e._v(" "),i("p",[e._v("From Epic Wiki")]),e._v(" "),i("p",[e._v("Jump to: "),i("a",{attrs:{href:"#mw-head"}},[e._v("navigation")]),e._v(", "),i("a",{attrs:{href:"#p-search"}},[e._v("search")])]),e._v(" "),i("h2",{attrs:{id:"contents"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#contents"}},[e._v("#")]),e._v(" Contents")]),e._v(" "),i("ul",[i("li",[i("a",{attrs:{href:"#Overview"}},[e._v("1 Overview")])]),e._v(" "),i("li",[i("a",{attrs:{href:"#Requirements"}},[e._v("2 Requirements")])]),e._v(" "),i("li",[i("a",{attrs:{href:"#Starting_off:_code_in_our_project"}},[e._v("3 Starting off: code in our project")])]),e._v(" "),i("li",[i("a",{attrs:{href:"#Aquiring"}},[e._v("4 Aquiring")])]),e._v(" "),i("li",[i("a",{attrs:{href:"#Copying_the_files"}},[e._v("5 Copying the files")])]),e._v(" "),i("li",[i("a",{attrs:{href:"#Linking"}},[e._v("6 Linking")])]),e._v(" "),i("li",[i("a",{attrs:{href:"#First_steps"}},[e._v("7 First steps")])]),e._v(" "),i("li",[i("a",{attrs:{href:"#Why_-1.3F_Why_luaL_dostring.28.29.3F_Why_this.3F_Why_that.3F"}},[e._v("8 Why -1? Why luaL_dostring()? Why this? Why that?")])]),e._v(" "),i("li",[i("a",{attrs:{href:"#Conclusion"}},[e._v("9 Conclusion")])])]),e._v(" "),i("h2",{attrs:{id:"overview"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#overview"}},[e._v("#")]),e._v(" Overview")]),e._v(" "),i("p",[e._v("Welcome to my third wiki page about the awesome game engine - Unreal! This article covers the question which people asked me a few times right now, and I think this could be useful for gameplay programming, and a great grade of mod-abilty: Integrating Lua. Lua itself is a programming language which is relatively easy to learn and to use, and with no big deal you can create gameplay scripts, and much more. In contrast to other programming languages, such as C/C++, Lua doesn't require compiling, which makes the workflow of developing really fast: Changing a bit in Lua code => reloading Lua scripts in the engine => Using the new code in the game. In languages like C++, we would need to compile the game first before we can use the new code, which takes longer than reloading script files.")]),e._v(" "),i("h2",{attrs:{id:"requirements"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#requirements"}},[e._v("#")]),e._v(" Requirements")]),e._v(" "),i("p",[e._v("To get Lua in our UE4 project, we don't need that much, and to be honest, also the work we need to afford to get Lua working is kept at a minimum here. To use Lua, we need a "),i("strong",[e._v("C++ code in our project")]),e._v(" (and therefore, a installation of Visual Studio on your computer). No matter if you started of with a blueprint or a C++ project, we are still on the right track! Also, "),i("strong",[e._v("intermediate C++ knowledge")]),e._v(" will help here, because we will dig down into the Lua C API, with it's pointers, variable types, converters, and more like that. Last stop is Lua itself. To use it, we need "),i("strong",[e._v("binaries and headers")]),e._v(". The headers are defining functions we can find in the binaries, so the compiler knows what we are talking about. Let's get started!")]),e._v(" "),i("h2",{attrs:{id:"starting-off-code-in-our-project"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#starting-off-code-in-our-project"}},[e._v("#")]),e._v(" Starting off: code in our project")]),e._v(" "),i("p",[e._v("If you already have a C++ project, you can skip this step. If not, we need to add code to the project so Unreal generates Visual Studio project files and build files. To do that, open up the editor of your project, go to "),i("strong",[e._v("File")]),e._v(" and choose "),i("strong",[e._v("New C++ class")]),e._v(". In the dialog we need to select the class we want to inherit our new piece of code from. Since we want to run Lua code from blueprints in this example, we choose "),i("strong",[e._v("Blueprint Function Library")]),e._v(". Click on Next, and enter the name for our new class (in this example I chose LuaBlueprints). Make sure the little "),i("strong",[e._v("Public")]),e._v(" button is selected, and then click on "),i("strong",[e._v("Create Class")]),e._v(". This should add the code to your project, compile it, and Visual Studio should open, and show the new class (one header and one source) files you created with the wizard.")]),e._v(" "),i("h2",{attrs:{id:"aquiring"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#aquiring"}},[e._v("#")]),e._v(" Aquiring")]),e._v(" "),i("p",[e._v("Now, we need to include Lua into the project, so it gets compiled with our project and is included in the final game. But first, we need to grab ourselves the Lua binaries. There are projects out there which supply you with precompiled binaries, or you can build your own! Because that takes time, and is rather nessecary, we'll take the precompiled version. "),i("a",{attrs:{href:"https://sourceforge.net/projects/luabinaries/files/",target:"_blank",rel:"noopener noreferrer"}},[e._v("LuaBinaries"),i("OutboundLink")],1),e._v(" is a great project, which is always up-to-date and has the binaries for every platform out there (we will just mess with Windows in this article). Choose the newest version, then "),i("strong",[e._v("Windows Libraries")]),e._v(", then "),i("strong",[e._v("Static")]),e._v(' since we will "embed" Lua inside our game\'s executable, and then search the package for your needs. '),i("a",{attrs:{href:"/index.php?title=Template:Note&action=edit&redlink=1",title:"Template:Note (page does not exist)"}},[e._v("Template:Note")]),e._v(" After we downloaded the packages, we should find the following structure inside:")]),e._v(" "),i("ul",[i("li",[e._v("include/ (essential includes for working with Lua)\n"),i("ul",[i("li",[e._v("lauxlib.h")]),e._v(" "),i("li",[e._v("lua.h")]),e._v(" "),i("li",[e._v("lua.hpp")]),e._v(" "),i("li",[e._v("luaconf.h")]),e._v(" "),i("li",[e._v("lualib.h")])])]),e._v(" "),i("li",[e._v("luaXX.lib (where XX is the current lua version (e.g. Lua 5.3.3 is lua53.lib))")])]),e._v(" "),i("p",[e._v("Now, that we have the binaries and the includes, we can go ahead to integrating them!")]),e._v(" "),i("h2",{attrs:{id:"copying-the-files"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#copying-the-files"}},[e._v("#")]),e._v(" Copying the files")]),e._v(" "),i("p",[e._v('Linking Lua in Unreal is easy. First off, we need to create a new folder in our project directory where we can put the Lua stuff inside. I personally prefer creating a new folder in the project\'s home (where your .uproject lives) and naming it "ThirdParty". Then it this folder, I created a folder called "Lua", and that splits up in "includes" and "libraries". Overview of the structure')]),e._v(" "),i("ul",[i("li",[e._v("Project Home/\n"),i("ul",[i("li",[e._v("ThirdParty/\n"),i("ul",[i("li",[e._v("Lua/\n"),i("ul",[i("li",[e._v("includes/ (we only need to copy them once, since they don't differ from the architecture | note the 's' in the end)")]),e._v(" "),i("li",[e._v("libraries/\n"),i("ul",[i("li",[e._v("luaXX.x64.lib (this is the library file you downloaded in the Win64 package, renamed for seperation)")]),e._v(" "),i("li",[e._v("luaXX.x86.lib (this is the library file you downloaded in the Win32 package, renamed for seperation)")])])])])])])])])])]),e._v(" "),i("h2",{attrs:{id:"linking"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#linking"}},[e._v("#")]),e._v(" Linking")]),e._v(" "),i("p",[e._v("In Visual Studio, open up the "),i("strong",[e._v("YourProjectName.Build.cs")]),e._v(" located in the Source/YourProjectName/ folder. By default, this file only links default engine modules. To link Lua against this, we need to add some code to it. Since this would be too much to go over every detail, I just show you what I did in my Build.cs: "),i("syntaxhighlight",{attrs:{lang:"csharp"}},[e._v(" using System.IO; using UnrealBuildTool;")])],1),e._v(" "),i("p",[e._v('public class ProjectName : ModuleRules { private string ThirdPartyPath { get { return Path.GetFullPath(Path.Combine(ModuleDirectory, "../../ThirdParty/")); } }')]),e._v(" "),i("p",[e._v('public ProjectName(TargetInfo Target) { PublicDependencyModuleNames.AddRange(new string[] { "Core", "CoreUObject", "Engine", "InputCore" });')]),e._v(" "),i("p",[e._v("PrivateDependencyModuleNames.AddRange(new string[] { });")]),e._v(" "),i("p",[e._v("// Uncomment if you are using Slate UI")]),e._v(" "),i("div",{staticClass:"language- extra-class"},[i("pre",[i("code",[e._v('           // PrivateDependencyModuleNames.AddRange(new string\\[\\] { "Slate", "SlateCore" });\n\n           // Uncomment if you are using online features\n           // PrivateDependencyModuleNames.Add("OnlineSubsystem");\n\n           // To include OnlineSubsystemSteam, add it to the plugins section in your uproject file with the Enabled attribute set to true\n\n           LoadLua(TargetRules); // This functions loads Lua\n')])])]),i("p",[e._v("}")]),e._v(" "),i("p",[e._v("private bool LoadLua(ReadOnlyTargetRules TargetRules) { bool isLibSupported = false;")]),e._v(" "),i("p",[e._v("// Check if we are on Windows if ((Target.Platform == UnrealTargetPlatform.Win64) || (Target.Platform == UnrealTargetPlatform.Win32)) { isLibSupported = true;")]),e._v(" "),i("p",[e._v('string PlatformString = (Target.Platform == UnrealTargetPlatform.Win64) ? "x64" : "x86"; // This string is either "x64" or "x86" so we can append it on the lib filename string LibrariesPath = Path.Combine(ThirdPartyPath, "Lua", "libraries");')]),e._v(" "),i("p",[e._v('PublicAdditionalLibraries.Add(Path.Combine(LibrariesPath, "lua53." + PlatformString + ".lib"));')]),e._v(" "),i("p",[e._v('PublicIncludePaths.Add(Path.Combine(ThirdPartyPath, "Lua", "includes")); }')]),e._v(" "),i("p",[e._v('Definitions.Add(string.Format("WITH_LUA_BINDING={0}", isLibSupported ? 1 : 0));')]),e._v(" "),i("p",[e._v("return isLibSupported; } } "),e._v(' The "LoadLua" method checks if we are on Windows, and if so, we create a string which either contains "x64" or "x86" depending on our architecture we compile for, so we can easily find the lib file. Then we create the libraries path, which is just the LibraryPath (in this Case "ThirdParty/")/Lua/libraries. From there, we append the platform string to the pre- and the suffix of the filename, so in the end it should be '),i("strong",[e._v("lua53.xxx.lib")]),e._v(". This path is added to "),i("strong",[e._v("PublicAdditionalLibraries")]),e._v(", which forces the compiler to use the lib file we put in there. We also add the includes directory to "),i("strong",[e._v("PublicIncludePaths")]),e._v(", so the compiler finds our includes. Last but not least we add a definition to the compiled game: "),i("strong",[e._v("WITH_LUA_BINDING=x")]),e._v(", where x is either 0 (when Lua is not supported) or 1 (when Lua is supported).")]),e._v(" "),i("h2",{attrs:{id:"first-steps"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#first-steps"}},[e._v("#")]),e._v(" First steps")]),e._v(" "),i("p",[e._v('Now, that we have integrated the lua binary into our game, let\'s try it out by right-clicking the project in Visual Studio and choose "Build". It should succeed! Next stop: writing a blueprint node which executes Lua code from a string we feed inside. Open up the header (.h) file of the blueprint function library you created. It is empty and should look like this: '),i("syntaxhighlight",{attrs:{lang:"cpp"}})],1),e._v(" "),i("ol",[i("li",[i("p",[e._v("pragma once")])]),e._v(" "),i("li",[i("p",[e._v('include "Kismet/BlueprintFunctionLibrary.h"')])]),e._v(" "),i("li",[i("p",[e._v('include "LuaBlueprints.generated.h"')])])]),e._v(" "),i("p",[e._v("/**")]),e._v(" "),i("p",[e._v("*\n*/")]),e._v(" "),i("p",[e._v("UCLASS() class YOURPROJECT_API ULuaBlueprints : public UBlueprintFunctionLibrary { GENERATED_BODY() }; "),e._v(" First of all, we add the Lua includes on top, so the compiler knows where our functions are declared. To do this, add "),i("strong",[e._v('#include "lua.hpp"')]),e._v(" on top of the other includes. Next, we add a new UFUNCTION to it, which is parsed to a blueprint node with the following declaration: "),i("syntaxhighlight",{attrs:{lang:"cpp"}},[e._v(' public: UFUNCTION(BlueprintCallable, Category = "Lua") static void RunLua(const FString& code); ')]),e._v(" This creates a callable blueprint node, which takes a string (FString) where we can enter Lua code which will be run. Note that this is static, since we don't have any object we want to call this in context, or in other words, we want to call it from everywhere without a target. Let's go into the LuaBlueprints.cpp file, which should be empty (except the includes). We add the definition for our RunLua function: "),i("syntaxhighlight",{attrs:{lang:"cpp"}},[e._v(" void ULuaBlueprints::RunLua(const FString& code) { lua_State* L = luaL_newstate(); luaL_openlibs(L);")])],1),e._v(" "),i("p",[e._v('int result = luaL_dostring(L, TCHAR_TO_ANSI(*code)); if (result != 0) { UE_LOG(LogTemp, Error, TEXT("Lua Script error: %s"), ANSI_TO_TCHAR(lua_tostring(L, -1))); } } '),e._v(" This is fairly easy. It uses the Lua C API to create a new Lua State, which we assign to the variable called L. Then, we open the standard lua libraries (such as math), and then we run the code by doing "),i("strong",[e._v("luaL_dostring()")]),e._v(". This takes the lua state L as one argument, and the code to run as the other argument. "),i("a",{attrs:{href:"/index.php?title=Template:Note&action=edit&redlink=1",title:"Template:Note (page does not exist)"}},[e._v("Template:Note")]),e._v(" That function returns an integer, which is 0 if everything went fine. If it is not 0, something obviously went wrong. In that case, I print it to the log with UE_LOG. Notice that we can get the Lua error message with "),i("strong",[e._v("lua_tostring(L, -1)")]),e._v(".")]),e._v(" "),i("h2",{attrs:{id:"why-1-why-lual-dostring-why-this-why-that"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#why-1-why-lual-dostring-why-this-why-that"}},[e._v("#")]),e._v(" Why -1? Why luaL_dostring()? Why this? Why that?")]),e._v(" "),i("p",[e._v('The Lua C API is strange sometimes, since it uses a stack based system, which means that values / functions are on a "stack", where the items can be accessed with indices. To get heavy things going with Lua, read through the Lua C API book '),i("a",{attrs:{href:"http://www.lua.org/manual/5.1/manual.html#3",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),i("OutboundLink")],1)]),e._v(" "),i("h2",{attrs:{id:"conclusion"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#conclusion"}},[e._v("#")]),e._v(" Conclusion")]),e._v(" "),i("p",[e._v("Congratulations, you read through a lot of text here. Now you should be able to compile it, and call the blueprint node from any graph and run lua code in it! From there, I leave you alone with the big, dangerous world of the Lua C API. If you have questions, feel free to ask me on my "),i("a",{attrs:{href:"https://forums.unrealengine.com/member.php?19899-iUltimateLP",target:"_blank",rel:"noopener noreferrer"}},[e._v("Unreal forums account"),i("OutboundLink")],1),e._v(". Have a nice day 😃")]),e._v(" "),i("p",[e._v('Retrieved from "'),i("a",{attrs:{href:"https://wiki.unrealengine.com/index.php?title=Integrating_Lua&oldid=457",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://wiki.unrealengine.com/index.php?title=Integrating_Lua&oldid=457"),i("OutboundLink")],1),e._v('"')])])}),[],!1,null,null,null);t.default=r.exports}}]);