(window.webpackJsonp=window.webpackJsonp||[]).push([[531],{778:function(e,t,a){"use strict";a.r(t);var o=a(28),r=Object(o.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("Garbage Collection & Dynamic Memory Allocation - Epic Wiki")]),e._v(" "),a("h1",{attrs:{id:"garbage-collection-dynamic-memory-allocation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#garbage-collection-dynamic-memory-allocation"}},[e._v("#")]),e._v(" Garbage Collection & Dynamic Memory Allocation")]),e._v(" "),a("h2",{attrs:{id:"contents"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#contents"}},[e._v("#")]),e._v(" Contents")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#Overview"}},[e._v("1 Overview")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Dynamic_Load_Object_From_Asset_Path"}},[e._v("2 Dynamic Load Object From Asset Path")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Disclaimer"}},[e._v("3 Disclaimer")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Dynamic_UObject_Allocation"}},[e._v("4 Dynamic UObject Allocation")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Preventing_Garbage_Collection"}},[e._v("5 Preventing Garbage Collection")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#.H"}},[e._v("5.1 .H")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#.CPP"}},[e._v("5.2 .CPP")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Implications_of_Not_Using_UPROPERTY.28.29"}},[e._v("5.3 Implications of Not Using UPROPERTY()")])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Using_UObject_Flag_to_Prevent_Garbage_Collection"}},[e._v("6 Using UObject Flag to Prevent Garbage Collection")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Counting_UPROPERTY.28.29_References_To_Any_Object"}},[e._v("7 Counting UPROPERTY() References To Any Object")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Destroying_.2F_Deallocating"}},[e._v("8 Destroying / Deallocating")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#Destroying_Objects"}},[e._v("8.1 Destroying Objects")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Destroying_Actors"}},[e._v("8.2 Destroying Actors")])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#IsValidLowLevel.28.29"}},[e._v("9 IsValidLowLevel()")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Weak_Pointers"}},[e._v("10 Weak Pointers")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#"}},[e._v("11")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Dynamic_Memory_Management"}},[e._v("12 Dynamic Memory Management")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#C.2B.2B_operator_new_and_delete"}},[e._v("12.1 C++ operator new and delete")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Every_New_Must_Have_a_Delete"}},[e._v("12.2 Every New Must Have a Delete")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Memory.h_.2F_FMemory::"}},[e._v("12.3 Memory.h / FMemory::")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Templated_UE4_C.2B.2B_Malloc_Function"}},[e._v("12.4 Templated UE4 C++ Malloc Function")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#Example_Usage"}},[e._v("12.4.1 Example Usage")])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#UE4_C.2B.2B_Free"}},[e._v("12.5 UE4 C++ Free")])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#If_You_Use_Malloc_You_Must_Use_Free"}},[e._v("13 If You Use Malloc You Must Use Free")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#UE4_new_operator_and_running_out_of_memory"}},[e._v("13.1 UE4 new operator and running out of memory")])])])]),e._v(" "),a("li",[a("a",{attrs:{href:"#How_to_Disable_GC_Verify_To_Avoid_Hitches"}},[e._v("14 How to Disable GC Verify To Avoid Hitches")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#Summary"}},[e._v("15 Summary")])])]),e._v(" "),a("h2",{attrs:{id:"overview"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#overview"}},[e._v("#")]),e._v(" Overview")]),e._v(" "),a("p",[a("em",[e._v("Original Author:")]),e._v(" "),a("a",{attrs:{href:"/User:Rama",title:"User:Rama"}},[e._v("Rama")]),e._v(" ("),a("a",{attrs:{href:"/User_talk:Rama",title:"User talk:Rama"}},[e._v("talk")]),e._v(")")]),e._v(" "),a("p",[e._v("Please note this tutorial in its present state reflects only my understanding and is not an Epic tutorial, you should examine the UE4 Source to get a more complete understanding of Dynamic Memory Management and the Garbage Collection System.")]),e._v(" "),a("p",[a("strong",[e._v("What I post here are the basics to get you startedÂ ðŸ˜ƒ")])]),e._v(" "),a("h2",{attrs:{id:"dynamic-load-object-from-asset-path"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dynamic-load-object-from-asset-path"}},[e._v("#")]),e._v(" Dynamic Load Object From Asset Path")]),e._v(" "),a("p",[e._v("See my Dynamic Load Object Tutorial!")]),e._v(" "),a("p",[a("strong",[a("a",{attrs:{href:"/Dynamic_Load_Object",title:"Dynamic Load Object"}},[e._v("Dynamic Load Object")])])]),e._v(" "),a("p",[e._v("This is how you load objects from an Asset Path, after creating those assets via the Editor!")]),e._v(" "),a("p",[e._v("You can use Dynamic Load Object to load a UStaticMesh into your game and then assign it to a Static Mesh Actor that you spawn, for example.")]),e._v(" "),a("p",[e._v("If you are new to C++ / UE4 C++ I recommend you start with my Dynamic Load Object tutorial.")]),e._v(" "),a("h2",{attrs:{id:"disclaimer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#disclaimer"}},[e._v("#")]),e._v(" Disclaimer")]),e._v(" "),a("p",[e._v("Please note that the rest of this tutorial is an advanced tutorial,\nand you should not attempt any of this until you are comfortable with C++ and UE4 C++.")]),e._v(" "),a("h2",{attrs:{id:"dynamic-uobject-allocation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dynamic-uobject-allocation"}},[e._v("#")]),e._v(" Dynamic UObject Allocation")]),e._v(" "),a("p",[e._v("//in any class\nUMyObjectClass* DynamicObj = NewObject<UMyObjectClass>(this);")]),e._v(" "),a("p",[e._v("this = Outer, if you are looking through the UE4 Source.")]),e._v(" "),a("h2",{attrs:{id:"preventing-garbage-collection"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#preventing-garbage-collection"}},[e._v("#")]),e._v(" Preventing Garbage Collection")]),e._v(" "),a("p",[a("strong",[e._v("UE4 Garbage Collection only counts references to UObjects that are UPROPERTY()")])]),e._v(" "),a("p",[e._v("To ensure that your spawned UObjects or objects created with NewObject are not Garbage Collected prematurely, you must have at least 1 reference to the UObject that is UPROPERTY()")]),e._v(" "),a("h3",{attrs:{id:"h"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#h"}},[e._v("#")]),e._v(" .H")]),e._v(" "),a("p",[e._v("UPROPERTY()\nUMyObjectClass* MyGCProtectedObj;")]),e._v(" "),a("h3",{attrs:{id:"cpp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cpp"}},[e._v("#")]),e._v(" .CPP")]),e._v(" "),a("p",[e._v("MyGCProtectedObj = NewObject<UMyObjectClass>(this);")]),e._v(" "),a("h3",{attrs:{id:"implications-of-not-using-uproperty"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#implications-of-not-using-uproperty"}},[e._v("#")]),e._v(" Implications of Not Using UPROPERTY()")]),e._v(" "),a("p",[e._v("If you do not use UPROPERTY() you can "),a("strong",[e._v("never rely on your dynamic UObject staying in existence!")]),a("br"),e._v(" "),a("strong",[e._v("Make sure you pay close attention to this if you are spawning UObjects or using NewObject())!")])]),e._v(" "),a("h2",{attrs:{id:"using-uobject-flag-to-prevent-garbage-collection"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-uobject-flag-to-prevent-garbage-collection"}},[e._v("#")]),e._v(" Using UObject Flag to Prevent Garbage Collection")]),e._v(" "),a("p",[e._v("You can also prevent an object from being garbage collected by setting the RF_RootSet flag.")]),e._v(" "),a("p",[e._v("YourObjectInstance->AddToRoot();")]),e._v(" "),a("h2",{attrs:{id:"counting-uproperty-references-to-any-object"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#counting-uproperty-references-to-any-object"}},[e._v("#")]),e._v(" Counting UPROPERTY() References To Any Object")]),e._v(" "),a("p",[e._v("I have created a wiki that shows you how you can find out exactly who is referring to your UObject/AActor at any time!")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://wiki.unrealengine.com/Garbage_Collection_~_Count_References_To_Any_Object#Code",target:"_blank",rel:"noopener noreferrer"}},[e._v("Garbage Collection ~ Count References To Any Object"),a("OutboundLink")],1)]),e._v(" "),a("h2",{attrs:{id:"destroying-deallocating"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#destroying-deallocating"}},[e._v("#")]),e._v(" Destroying / Deallocating")]),e._v(" "),a("h3",{attrs:{id:"destroying-objects"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#destroying-objects"}},[e._v("#")]),e._v(" Destroying Objects")]),e._v(" "),a("p",[e._v("You can destroy objects created during runtime using:")]),e._v(" "),a("p",[e._v("if(!MyObject) return;\nif(!MyObject->IsValidLowLevel()) return;\nÂ \nMyObject->ConditionalBeginDestroy(); //instantly clears UObject out of memory\nMyObject = nullptr;")]),e._v(" "),a("h3",{attrs:{id:"destroying-actors"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#destroying-actors"}},[e._v("#")]),e._v(" Destroying Actors")]),e._v(" "),a("p",[e._v("You can destroy AActor extending classes using")]),e._v(" "),a("p",[e._v("if(!TheCharacter) return;\nif(!TheCharacter->IsValidLowLevel()) return;\nTheCharacter->Destroy();\nTheCharacter->ConditionalBeginDestroy(); //essential extra step, in all my testing")]),e._v(" "),a("h2",{attrs:{id:"isvalidlowlevel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#isvalidlowlevel"}},[e._v("#")]),e._v(" IsValidLowLevel()")]),e._v(" "),a("p",[e._v("You must always check if a UObject or AActor is valid before deferencing the pointer to it!")]),e._v(" "),a("p",[e._v("If you are wanting to use Dynamic Allocation of UObjects,\nyou really should also use IsValidLowLevel()")]),e._v(" "),a("p",[e._v("//Get the Name of my Dynamic Object\nÂ \nif(!MyGCProtectedObj) return;\nif(!MyGCProtectedObj->IsValidLowLevel()) return;\n//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nÂ \n//It is safe to dereference nowÂ ðŸ˜ƒ\nClientMessage(MyGCProtectedObj->GetName());")]),e._v(" "),a("p",[e._v("IsValidLowLevel() checks the actual validity of the created UObject and can prevent crashes where a simple pointer check wouldn't, because the pointer is valid but is pointing to an incomplete / partially deconstructed UObject.")]),e._v(" "),a("h2",{attrs:{id:"weak-pointers"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#weak-pointers"}},[e._v("#")]),e._v(" Weak Pointers")]),e._v(" "),a("p",[e._v("Quoting Epic Dev Matt")]),e._v(" "),a("p",[e._v("If you know that the lifetime of an object is managed elsewhere\nand you just want to observe it and not contribute any references to it,\nyou can hold onto a TWeakObjectPtr to that object\nwhich will safely be nulled out when the object is destroyed.")]),e._v(" "),a("p",[e._v("TWeakObjectPtr<UStaticMesh> MeshThatCouldBeNull;")]),e._v(" "),a("h2",{attrs:{id:"dynamic-memory-management"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dynamic-memory-management"}},[e._v("#")]),e._v(" Dynamic Memory Management")]),e._v(" "),a("h3",{attrs:{id:"c-operator-new-and-delete"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#c-operator-new-and-delete"}},[e._v("#")]),e._v(" C++ operator new and delete")]),e._v(" "),a("p",[e._v("Although you can use Malloc and free as I explain below, I personally recommend that you use c++ operator "),a("strong",[e._v("new")]),e._v(" and "),a("strong",[e._v("delete")]),e._v("!")]),e._v(" "),a("p",[e._v("This is because C++ operator new "),a("strong",[e._v("properly initializes the vtable")]),e._v(" (virtual function table) for any virtual functions in your data type, and also "),a("strong",[e._v("calls the constructor")]),e._v(" for your data type!")]),e._v(" "),a("p",[e._v("FYourDataType* NewDataPtr = new FYourDataType();")]),e._v(" "),a("h3",{attrs:{id:"every-new-must-have-a-delete"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#every-new-must-have-a-delete"}},[e._v("#")]),e._v(" Every New Must Have a Delete")]),e._v(" "),a("p",[e._v("Please note you absolutely must "),a("strong",[e._v("pair every use of new with a delete")]),e._v(" to avoid memory leaks, as you are now doing your own memory management!")]),e._v(" "),a("p",[e._v("delete NewDataPtr;")]),e._v(" "),a("h3",{attrs:{id:"memory-h-fmemory"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#memory-h-fmemory"}},[e._v("#")]),e._v(" Memory.h / FMemory::")]),e._v(" "),a("p",[e._v("Use the Memory.h functions!")]),e._v(" "),a("p",[e._v("Do not use c++ level memory functions!")]),e._v(" "),a("p",[e._v("Memory.h contains UE4 C++ versions of C++ memory management functions\nthat are maintained by Epic as the engine evolves.")]),e._v(" "),a("h3",{attrs:{id:"templated-ue4-c-malloc-function"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#templated-ue4-c-malloc-function"}},[e._v("#")]),e._v(" Templated UE4 C++ Malloc Function")]),e._v(" "),a("p",[e._v("Here is my very own Templated Malloc function which I used to make my "),a("strong",[a("a",{attrs:{href:"/Victory_Game#Undo_Feature",title:"Victory Game"}},[e._v("In-game Editor Undo system!")])])]),e._v(" "),a("p",[a("strong",[a("a",{attrs:{href:"/Victory_Game#Undo_Feature",title:"Victory Game"}},[e._v("Video of my In-game Editor Undo system!")])])]),e._v(" "),a("p",[e._v("//The purpose of this template is to ensure no typos when malloc-ing\n//  types that are related and will pass static cast, but if there's a typo could be allocating\n//  insufficient amount of space\nÂ \n//the name is VStruct because I was mallocing USTRUCTS\nÂ \ntemplate <typename DataType>\nFORCEINLINE DataType* VStructMalloc()\n{\nreturn\tstatic_cast<DataType*>(FMemory::Malloc(sizeof(DataType)));\n}")]),e._v(" "),a("h4",{attrs:{id:"example-usage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#example-usage"}},[e._v("#")]),e._v(" Example Usage")]),e._v(" "),a("p",[e._v("FVictoryUndoDataCreateWall* NewUndo = VStructMalloc<FVictoryUndoDataCreateWall>();\nif(!NewUndo) return;")]),e._v(" "),a("h3",{attrs:{id:"ue4-c-free"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ue4-c-free"}},[e._v("#")]),e._v(" UE4 C++ Free")]),e._v(" "),a("p",[e._v("FMemory::Free(NewUndo);")]),e._v(" "),a("h2",{attrs:{id:"if-you-use-malloc-you-must-use-free"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#if-you-use-malloc-you-must-use-free"}},[e._v("#")]),e._v(" If You Use Malloc You Must Use Free")]),e._v(" "),a("p",[e._v("Every Malloc must be paired with a Free when you are doing your own Dynamic Memory management, or you will have a Memory Leak.")]),e._v(" "),a("p",[e._v("FMemory::Malloc\nFMemory::Free")]),e._v(" "),a("h3",{attrs:{id:"ue4-new-operator-and-running-out-of-memory"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ue4-new-operator-and-running-out-of-memory"}},[e._v("#")]),e._v(" UE4 new operator and running out of memory")]),e._v(" "),a("p",[e._v("From AnswerHub answer by Jamie Dale:")]),e._v(" "),a("blockquote",[a("p",[e._v("UObject and UStruct types overload operator new via one of the nested macros within GENERATED_UCLASS_BODY and GENERATED_USTRUCT_BODY. Slate widgets also override this operator, as do modules via REPLACEMENT_OPERATOR_NEW_AND_DELETE.")]),e._v(" "),a("p",[e._v("The module level replacement seems to catch all the allocations made within a module, even if you're not allocating a UObject, UStruct, or Slate widget.")]),e._v(" "),a("p",[e._v("Ultimately they call through to FMemory::Malloc, which will forward it onto whichever allocator is active (eg, FMallocTBB). If one of these allocators fails to perform an allocation, they will call an implementation specific OutOfMemory function to log a fatal error.")]),e._v(" "),a("p",[e._v("I tried allocating 0x7fffffffffffffff bytes. With a debugger attached, it broke into the debugger on the failed allocation; without a debugger attached, the application just quit.")])]),e._v(" "),a("h2",{attrs:{id:"how-to-disable-gc-verify-to-avoid-hitches"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-to-disable-gc-verify-to-avoid-hitches"}},[e._v("#")]),e._v(" How to Disable GC Verify To Avoid Hitches")]),e._v(" "),a("p",[e._v("If you want to disable GC in release builds to avoid hitches (if you are experiencing them)")]),e._v(" "),a("p",[e._v("In the commandline when you run the game:")]),e._v(" "),a("p",[e._v("-NoVerifyGC")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://docs.unrealengine.com/latest/INT/Engine/Performance/Options/index.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Epic Documentation"),a("OutboundLink")],1)]),e._v(" "),a("p",[a("a",{attrs:{href:"https://answers.unrealengine.com/questions/177892/game-hitches-gc-mark-time.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("AnswerHub Explanation by Epic Dev Robert"),a("OutboundLink")],1)]),e._v(" "),a("h2",{attrs:{id:"summary"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#summary"}},[e._v("#")]),e._v(" Summary")]),e._v(" "),a("p",[e._v("Now you know how to dynamically spawn / create UObjects and also prevent them from getting Garbage Collected!")]),e._v(" "),a("p",[e._v("You also know how to prevent your game from crashing constantly.")]),e._v(" "),a("p",[e._v("It's called IsValidLowLevel()Â !!!")]),e._v(" "),a("p",[e._v("You also have a very brief intro into Dynamic Memory Management which I plan to let you explore further by studying Memory.h directly.")]),e._v(" "),a("p",[e._v("Enjoy!")]),e._v(" "),a("p",[a("a",{attrs:{href:"/User:Rama",title:"User:Rama"}},[e._v("Rama")]),e._v(" ("),a("a",{attrs:{href:"/User_talk:Rama",title:"User talk:Rama"}},[e._v("talk")]),e._v(")")]),e._v(" "),a("p",[e._v('Retrieved from "'),a("a",{attrs:{href:"https://wiki.unrealengine.com/index.php?title=Garbage_Collection_%26_Dynamic_Memory_Allocation&oldid=23255",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://wiki.unrealengine.com/index.php?title=Garbage_Collection_%26_Dynamic_Memory_Allocation&oldid=23255"),a("OutboundLink")],1),e._v('"')]),e._v(" "),a("p",[a("a",{attrs:{href:"/Special:Categories",title:"Special:Categories"}},[e._v("Category")]),e._v(":")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"/Category:Code",title:"Category:Code"}},[e._v("Code")])])]),e._v(" "),a("p",[a("img",{attrs:{src:"https://tracking.unrealengine.com/track.png",alt:""}})])])}),[],!1,null,null,null);t.default=r.exports}}]);