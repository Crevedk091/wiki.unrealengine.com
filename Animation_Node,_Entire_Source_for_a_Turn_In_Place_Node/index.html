<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>wiki.unrealengine.com</title>
    <meta name="description" content="A static site pulled from the internet archive">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/wiki.unrealengine.com/assets/css/0.styles.b0e83839.css" as="style"><link rel="preload" href="/wiki.unrealengine.com/assets/js/app.aaf63946.js" as="script"><link rel="preload" href="/wiki.unrealengine.com/assets/js/2.4f53495e.js" as="script"><link rel="preload" href="/wiki.unrealengine.com/assets/js/70.6d6a731c.js" as="script">
    <link rel="stylesheet" href="/wiki.unrealengine.com/assets/css/0.styles.b0e83839.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wiki.unrealengine.com/" class="home-link router-link-active"><!----> <span class="site-name">wiki.unrealengine.com</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p>Animation Node, Entire Source for a Turn In Place Node - Epic Wiki</p> <h1 id="animation-node-entire-source-for-a-turn-in-place-node"><a href="#animation-node-entire-source-for-a-turn-in-place-node" class="header-anchor">#</a> Animation Node, Entire Source for a Turn In Place Node</h1> <h2 id="contents"><a href="#contents" class="header-anchor">#</a> Contents</h2> <ul><li><a href="#Overview">1 Overview</a></li> <li><a href="#Animation_USTRUCT">2 Animation USTRUCT</a> <ul><li><a href="#.h">2.1 .h</a></li> <li><a href="#.CPP">2.2 .CPP</a></li></ul></li> <li><a href="#World_Is_Game">3 World Is Game</a></li> <li><a href="#Animation_Graph_Node">4 Animation Graph Node</a> <ul><li><a href="#.H_2">4.1 .H</a></li> <li><a href="#.CPP_2">4.2 .CPP</a></li></ul></li></ul> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p><em>Original Author</em> <a href="/User:Rama" title="User:Rama">Rama</a> (<a href="/User_talk:Rama" title="User talk:Rama">talk</a>)</p> <p>Dear Community,</p> <p>Here is my entire code for a Turn In Place animation node!</p> <p>This node detects when there is little to no velocity, but the character is changing directions constantly.</p> <p>This code shows you my method of accessing the player character from within the animation node code.</p> <p><a href="/File:TurnInPlacenode.jpg"><img src="https://d3ar1piqh1oeli.cloudfront.net/1/19/TurnInPlacenode.jpg/800px-TurnInPlacenode.jpg" alt="TurnInPlacenode.jpg"></a></p> <h2 id="animation-ustruct"><a href="#animation-ustruct" class="header-anchor">#</a> Animation USTRUCT</h2> <h3 id="h"><a href="#h" class="header-anchor">#</a> .h</h3> <p>// Copyright 1998-2013 Epic Games, Inc. All Rights Reserved.
 
#pragma once
#include &quot;AnimNode_VictoryTurnInPlace.generated.h&quot;
 
USTRUCT()
struct FAnimNode_VictoryTurnInPlace : public FAnimNode_Base
{
GENERATED_USTRUCT_BODY()
 
/** Base Pose*/
UPROPERTY(EditAnywhere, BlueprintReadWrite, Category=Links)
FPoseLink BasePose;
 
/** Turning In Place! */
UPROPERTY(EditAnywhere, BlueprintReadWrite, Category=Links)
FPoseLink TurnPose;
 
/** How Quickly to Blend In/Out of Turn Pose */
UPROPERTY(EditAnywhere, BlueprintReadWrite, Category=Links, meta=(PinShownByDefault))
float TurnBlendDuration;
 
/** What Amount of Turn Per Tick Qualifies for Maximum Turn Blending? Anything less per tick will result in slower Turn Blending. Result: If player turns slowly, the turn blend blends in slowly, and ramps up smoothly to max turn blend as player turns faster. */
UPROPERTY(EditAnywhere, BlueprintReadWrite, Category=Links, meta=(PinShownByDefault))
float TurnSpeedModifierMAX;
 
/** The Lower This Number The Faster The Turn In Place Anim Will Activate */
UPROPERTY(EditAnywhere, BlueprintReadWrite, Category=Links, meta=(PinShownByDefault))
float TurnSensitivity;
 
/** The Lower This Number The Faster The Turn In Place Anim Will Activate */
UPROPERTY(EditAnywhere, BlueprintReadWrite, Category=Links, meta=(PinShownByDefault) )
float MoveSensitivity;
 
/** Seeing this in the log can help you decided what TurnSpeedModifierMAX to use  */
UPROPERTY(EditAnywhere, BlueprintReadWrite, Category=Logs)
float ShowTurnRotationChangePerTick;
 
// FAnimNode_Base interface
public:
 
// FAnimNode_Base interface
virtual void Initialize(const FAnimationInitializeContext&amp; Context) 	OVERRIDE;
virtual void Update(const FAnimationUpdateContext &amp; Context) 		OVERRIDE;
virtual void Evaluate(FPoseContext&amp; Output) 							OVERRIDE;
// End of FAnimNode_Base interface
 
//~~~ Constructor ~~~
public:
 
FAnimNode_VictoryTurnInPlace();
 
//Functions
protected:
void DetermineUseTurnPose();
void UpdateBlendAlpha();
 
protected:	
 
//Our very own Blend node, yay! (makes this all super clear)
FAnimationNode_TwoWayBlend OurVeryOwnBlend;
 
AActor * OwningActor;
FVector PrevLoc;
FVector CurLoc;
float PrevYaw;
float CurYaw;
float TurnAmountThisTick;
bool WorldIsGame;
 
//~~~ Blending ~~~
float BlendDurationMult; //blend slower if moving slower
float InternalBlendDuration; //divided the input by 100 just cause it looks better that way
float BlendAlpha;
bool BlendingIntoTurnPose; //false = blending out of
 
FVector2D RangeIn;
FVector2D RangeOut;
};</p> <h3 id="cpp"><a href="#cpp" class="header-anchor">#</a> .CPP</h3> <p>// Copyright 1998-2013 Epic Games, Inc. All Rights Reserved.
 
#include &quot;VictoryGame.h&quot;
 
//#include &quot;AnimationRuntime.h&quot;
 
FAnimNode_VictoryTurnInPlace::FAnimNode_VictoryTurnInPlace()
: FAnimNode_Base()
, TurnBlendDuration(4.f)
, TurnSpeedModifierMAX(4.333)
, TurnSensitivity(0.777f)
, MoveSensitivity(25.f)
{
WorldIsGame = false;
BlendDurationMult = 1;
InternalBlendDuration = TurnBlendDuration / 100;
 
RangeIn = FVector2D(0, TurnSpeedModifierMAX);
RangeOut = FVector2D(0, 1);
 
ShowTurnRotationChangePerTick = false;
}
 
void FAnimNode_VictoryTurnInPlace::Initialize(const FAnimationInitializeContext &amp; Context)
{
//Init the Inputs
BasePose.Initialize(Context);
TurnPose.Initialize(Context);
 
//Get the Actor Owner
OwningActor = Context.AnimInstance-&gt; GetSkelMeshComponent()-&gt;GetOwner();
 
//Editor or Game?
UWorld * TheWorld = Context.AnimInstance-&gt;GetWorld();
if (!TheWorld) return;
//~~~~~~~~~~~~~~~~
 
WorldIsGame = (TheWorld-&gt;WorldType == EWorldType::Game);
 
//~~~
 
//~~~ Init the Blend ~~~
OurVeryOwnBlend.A = BasePose;
OurVeryOwnBlend.B = TurnPose;
OurVeryOwnBlend.Initialize(Context);
}
 
void FAnimNode_VictoryTurnInPlace::DetermineUseTurnPose()
{
//Delta time
//Context.GetDeltaTime();
 
//Get Current
CurYaw = OwningActor-&gt;GetActorRotation().Yaw;
CurLoc =  OwningActor-&gt;GetActorLocation();
 
//~~~ Choose Turn Pose or Base Pose ~~~
//Yaw Delta Amount
TurnAmountThisTick = FMath::Abs(CurYaw - PrevYaw);
if (TurnAmountThisTick &lt; TurnSensitivity)
{
BlendingIntoTurnPose = false;
}
 
//Turning Amount is Sufficient and Movement is slow enough
else if(FVector::DistSquared(CurLoc, PrevLoc) &lt; MoveSensitivity)
{
BlendingIntoTurnPose = true;
}
 
//~~~ Save Previous ~~~
PrevYaw = CurYaw;
PrevLoc = CurLoc;
 
//Log the Change in Rotation Per Tick
if(ShowTurnRotationChangePerTick) UE_LOG(LogAnimation, Warning, TEXT(&quot;turn difference per tick,  %f&quot;), TurnAmountThisTick);
 
//~~~ Calc Blend Mult ~~~
 
//In case this gets modified during game time
RangeIn.Y = TurnSpeedModifierMAX;
 
//Mapped Range
BlendDurationMult = FMath::GetMappedRangeValue(RangeIn, RangeOut, TurnAmountThisTick);
}
void FAnimNode_VictoryTurnInPlace::UpdateBlendAlpha()
{
if (BlendingIntoTurnPose)
{
if (BlendAlpha &gt;= 1) BlendAlpha = 1;
else BlendAlpha += InternalBlendDuration * BlendDurationMult; //modify blend-in by speed of turning
}
 
//Blending out
else
{
if (BlendAlpha &lt;= 0) BlendAlpha = 0;
else BlendAlpha -= InternalBlendDuration;
}
}
void FAnimNode_VictoryTurnInPlace::Update(const FAnimationUpdateContext &amp; Context)
{
//EDITOR
//Editor mode? just use the base pose
if (!WorldIsGame)
{
BlendAlpha = 0;
}
 
//GAME
//Actually in Game so the Owner Instance Should Exist
else
{
//Try Again if not found
if (!OwningActor) OwningActor = Context.AnimInstance-&gt;GetSkelMeshComponent()-&gt;GetOwner();
 
//Not found
if (!OwningActor)
{
UE_LOG(LogAnimation, Warning, TEXT(&quot;FAnimNode_VictoryTurnInPlace::Update() Owning Actor was not found&quot;));
return;
//~~~~~~~~~~~~~~~~~~~
}
 
//~~~ Determine Use Turn Pose ~~~
DetermineUseTurnPose();
 
//~~~ Calc Blend Alpha ~~~
UpdateBlendAlpha();
}
 
//~~~ Do Updates ~~~
 
//At end of Blend, only evaluate 1, save resources
//**************************************************************************
// FPoseLinkBase::Update Active Pose - this is what makes the glowing line thing happen and animations loop
//**************************************************************************
if (BlendAlpha &gt;= 1) TurnPose.Update(Context);
else if (BlendAlpha &lt;= 0) BasePose.Update(Context);
 
//Currently Blending
else
{		
//Blend node below handles this now
//BasePose.Update(Context);
//TurnPose.Update(Context);
 
//~~~ Update the Blend ~~~
OurVeryOwnBlend.Alpha = BlendAlpha;
OurVeryOwnBlend.Update(Context);
}
 
//***************************************
// Evaluate Graph, see AnimNode_Base, AnimNodeBase.h
EvaluateGraphExposedInputs.Execute(Context);
//***************************************
}
 
void FAnimNode_VictoryTurnInPlace::Evaluate(FPoseContext &amp; Output)
{
//~~~ Fully In Base Pose ~~~
if(BlendAlpha &lt;= 0) BasePose.Evaluate(Output);
 
//~~~ Fully In Turn Pose ~~~
else if (BlendAlpha &gt;= 1) TurnPose.Evaluate(Output);
 
//~~~ Currently Blending ~~~
else
{
OurVeryOwnBlend.Evaluate(Output);
}	
}</p> <h2 id="world-is-game"><a href="#world-is-game" class="header-anchor">#</a> World Is Game</h2> <p>Please note the use of WorldIsGame.</p> <p>In the editor, there is no instanced version of the Character, so I do not run that part of the code.</p> <p>Here is how you can determine if your node is running in the Editor preview or in the actual game!</p> <p>WorldIsGame = (TheWorld-&gt;WorldType == EWorldType::Game);</p> <h2 id="animation-graph-node"><a href="#animation-graph-node" class="header-anchor">#</a> Animation Graph Node</h2> <h3 id="h-2"><a href="#h-2" class="header-anchor">#</a> .H</h3> <p>// Copyright 1998-2013 Epic Games, Inc. All Rights Reserved.
 
#pragma once
 
#include &quot;AnimGraphDefinitions.h&quot;
#include &quot;Kismet2/BlueprintEditorUtils.h&quot;
 
#include &quot;AnimGraphNode_VictoryTurnInPlace.generated.h&quot;
 
//Whole point of this is to be wrapper for node struct
//		so it depends on it, and that node must compile first
//		for type to be recognized
 
UCLASS(MinimalAPI, dependson=FAnimNode_VictoryTurnInPlace)
class UAnimGraphNode_VictoryTurnInPlace : public UAnimGraphNode_Base
{
GENERATED_UCLASS_BODY()
 
UPROPERTY(EditAnywhere, Category=Settings)
FAnimNode_VictoryTurnInPlace Node;
 
public:
// UEdGraphNode interface
virtual FString GetNodeTitle(ENodeTitleType::Type TitleType) const OVERRIDE;
virtual FLinearColor GetNodeTitleColor() const OVERRIDE;
virtual FString GetNodeCategory() const OVERRIDE;
// End of UEdGraphNode interface
 
protected:
// UAnimGraphNode_SkeletalControlBase interface
virtual FString GetControllerDescription() const;
// End of UAnimGraphNode_SkeletalControlBase interface
};</p> <h3 id="cpp-2"><a href="#cpp-2" class="header-anchor">#</a> .CPP</h3> <p>// Copyright 1998-2013 Epic Games, Inc. All Rights Reserved.
 
#include &quot;VictoryGame.h&quot;
 
/////////////////////////////////////////////////////
// UAnimGraphNode_VictoryTurnInPlace
 
UAnimGraphNode_VictoryTurnInPlace::UAnimGraphNode_VictoryTurnInPlace(const FPostConstructInitializeProperties&amp; PCIP)
: Super(PCIP)
{
}
 
//Title Color!
FLinearColor UAnimGraphNode_VictoryTurnInPlace::GetNodeTitleColor() const
{
return FLinearColor(0,12,12,1);
}
 
//Node Category
FString UAnimGraphNode_VictoryTurnInPlace::GetNodeCategory() const
{
return FString(&quot;Victory Anim Nodes&quot;);
}
FString UAnimGraphNode_VictoryTurnInPlace::GetControllerDescription() const
{
return TEXT(&quot;~~~ Victory Turn In Place ~~~&quot;);
}
 
FString UAnimGraphNode_VictoryTurnInPlace::GetNodeTitle(ENodeTitleType::Type TitleType) const
{
FString Result = *GetControllerDescription();
Result += (TitleType == ENodeTitleType::ListView) ? TEXT(&quot;&quot;) : TEXT(&quot;\n&quot;);
return Result;
}</p> <p>Enjoy!</p> <p><a href="/User:Rama" title="User:Rama">Rama</a> (<a href="/User_talk:Rama" title="User talk:Rama">talk</a>)</p> <p>In UE 4.7 you need adequate include headers for FAnim* classes :</p> <ol><li>include &quot;Runtime/Engine/Classes/Animation/AnimNodeBase.h&quot;</li> <li>include &quot;Runtime/Engine/Classes/Animation/InputScaleBias.h&quot;</li> <li>include &quot;Runtime/Engine/Classes/Animation/AnimNode_TwoWayBlend.h&quot;</li></ol> <p>Retrieved from &quot;<a href="https://wiki.unrealengine.com/index.php?title=Animation_Node,_Entire_Source_for_a_Turn_In_Place_Node&amp;oldid=12295" target="_blank" rel="noopener noreferrer">https://wiki.unrealengine.com/index.php?title=Animation_Node,_Entire_Source_for_a_Turn_In_Place_Node&amp;oldid=12295<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>&quot;</p> <p><a href="/Special:Categories" title="Special:Categories">Categories</a>:</p> <ul><li><a href="/index.php?title=Category:Notes&amp;action=edit&amp;redlink=1" title="Category:Notes (page does not exist)">Notes</a></li> <li><a href="/Category:Code" title="Category:Code">Code</a></li></ul> <p><img src="https://tracking.unrealengine.com/track.png" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/wiki.unrealengine.com/assets/js/app.aaf63946.js" defer></script><script src="/wiki.unrealengine.com/assets/js/2.4f53495e.js" defer></script><script src="/wiki.unrealengine.com/assets/js/70.6d6a731c.js" defer></script>
  </body>
</html>
